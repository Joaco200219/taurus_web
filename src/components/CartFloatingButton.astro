---
// CartFloatingButton.astro
// TODO: Reemplazar con el nÃºmero de WhatsApp de Branco Burgers (sin + ni espacios, ej: 5491112345678)
const WHATSAPP_NUMBER = '[NUMERO_WHATSAPP]';
---

<div id="cart-component-root" data-whatsapp={WHATSAPP_NUMBER}>

  <div
    id="checkout-modal-overlay"
    class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4"
    style="background: rgba(0,0,0,0.80); backdrop-filter: blur(4px); display: none !important;"
    aria-modal="true"
    role="dialog"
    aria-labelledby="modal-title"
  >
    <div
      id="checkout-modal"
      class="relative w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl overflow-hidden flex flex-col"
      style="background: #F5F0E8; border: 2px solid #0D0D0D; box-shadow: 6px 6px 0px #E8681A; max-height: 92dvh;"
    >
      <!-- Burger pattern â€” same as body, clipped by modal's overflow:hidden -->
      <div
        aria-hidden="true"
        style="position:absolute;inset:0;z-index:0;pointer-events:none;background-image:url('/img/burger-pattern.png');background-size:320px 320px;background-repeat:repeat;opacity:0.08;mix-blend-mode:multiply;"
      ></div>
      <!-- Modal header -->
      <div class="flex items-center justify-between px-5 py-4 flex-shrink-0" style="border-bottom: 2px solid #0D0D0D;">
        <div>
          <h2 id="modal-title" style="font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; color: #E8681A; letter-spacing: 0.03em;">FINALIZAR PEDIDO ğŸ›’</h2>
          <p class="text-xs mt-0.5" style="color: #6B6660; font-weight: 600;">CompletÃ¡ los datos para tu pedido</p>
        </div>
        <button
          id="modal-close-btn"
          class="w-9 h-9 rounded-full flex items-center justify-center text-lg transition-all active:scale-90"
          style="background: #0D0D0D; color: #F5F0E8; border: 1.5px solid #0D0D0D;"
          aria-label="Cerrar modal"
        >âœ•</button>
      </div>

      <div class="overflow-y-auto flex-1 px-5 py-4 space-y-5">

        <!-- Order summary -->
        <div class="p-4" style="background: #FFFFFF; border: 2px solid #0D0D0D; box-shadow: 3px 3px 0px #E8681A;">
          <div class="flex items-center justify-between mb-3">
            <p style="font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; color: #0D0D0D; letter-spacing: 0.06em;">TU PEDIDO</p>
            <button
              id="clear-cart-btn"
              class="text-xs font-bold px-2 py-1 rounded-lg transition-all active:scale-90"
              style="background: #F5F0E8; color: #E8681A; border: 2px solid #0D0D0D;"
            >
              ğŸ—‘ Vaciar pedido
            </button>
          </div>
          <ul id="modal-items-list" class="space-y-2 mb-3"></ul>
          <div class="flex items-center justify-between pt-3" style="border-top: 1.5px solid #0D0D0D;">
            <span class="text-sm font-bold" style="color: #6B6660;">Subtotal</span>
            <span id="modal-subtotal" class="text-base font-bold" style="color: #0D0D0D;"></span>
          </div>
          <!-- Shipping cost row (only visible on delivery) -->
          <div id="shipping-cost-row" class="flex items-center justify-between pt-2" style="display: none !important;">
            <span class="text-sm font-bold" style="color: #E8681A; font-weight: 800;">ğŸ›µ EnvÃ­o</span>
            <span id="modal-shipping-cost" class="text-base font-bold" style="color: #E8681A;"></span>
          </div>
          <!-- Grand total -->
          <div class="flex items-center justify-between pt-2 mt-1" style="border-top: 2px solid #0D0D0D;">
            <span style="font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; color: #0D0D0D;">TOTAL</span>
            <span id="modal-total" style="font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; color: #E8681A;"></span>
          </div>
        </div>

        <!-- Delivery type -->
        <div>
          <p style="font-family: 'Bebas Neue', sans-serif; font-size: 1rem; color: #0D0D0D; letter-spacing: 0.05em; margin-bottom: 10px;">TIPO DE ENTREGA</p>
          <div class="grid grid-cols-2 gap-2">
            <button
              id="toggle-delivery"
              class="delivery-toggle py-3 px-4 rounded-xl font-bold text-sm transition-all duration-200 flex items-center justify-center gap-2 active:scale-95"
              data-type="delivery"
              style="background: #E8681A; color: #0D0D0D; border: 2px solid #0D0D0D; box-shadow: 3px 3px 0px #0D0D0D; font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; letter-spacing: 0.04em;"
            >
              ğŸ›µ DELIVERY
            </button>
            <button
              id="toggle-retiro"
              class="delivery-toggle py-3 px-4 rounded-xl font-bold text-sm transition-all duration-200 flex items-center justify-center gap-2 active:scale-95"
              data-type="retiro"
              style="background: #F5F0E8; color: #6B6660; border: 2px solid #0D0D0D; box-shadow: 3px 3px 0px #0D0D0D; font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; letter-spacing: 0.04em;"
            >
              ğŸª RETIRO LOCAL
            </button>
          </div>
        </div>

        <!-- Delivery fields -->
        <div id="field-delivery" class="space-y-3">
          <!-- Address field with calculate button -->
          <div class="space-y-1.5">
            <label for="input-direccion" class="text-sm font-bold" style="color: #0D0D0D;">
              ğŸ  DirecciÃ³n completa
            </label>
            <input
              id="input-direccion"
              type="text"
              placeholder="Ej: Av. ColÃ³n 1234, CÃ³rdoba"
              class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all"
              style="background: #FFFFFF; border: 2px solid #0D0D0D; color: #0D0D0D;"
              autocomplete="off"
            />
            <button
              id="calc-envio-btn"
              class="w-full py-3 px-4 rounded-xl font-bold text-sm transition-all duration-200 flex items-center justify-center gap-2 active:scale-95"
              style="background: #0D0D0D; color: #F5F0E8; border: 2px solid #0D0D0D; box-shadow: 3px 3px 0px #E8681A; font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem; letter-spacing: 0.04em;"
            >
              ğŸ“ Calcular costo de envÃ­o
            </button>
          </div>

          <!-- Shipping result panel -->
          <div id="shipping-result" style="display: none;">
            <!-- Populated by JS: states = loading | success | error -->
          </div>
        </div>

        <!-- Pickup name -->
        <div id="field-retiro" class="space-y-1.5 hidden">
          <label for="input-nombre" class="text-sm font-bold" style="color: #0D0D0D;">
            ğŸ‘¤ Nombre de quien retira
          </label>
          <input
            id="input-nombre"
            type="text"
            placeholder="Ej: Juan GarcÃ­a"
            class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all"
            style="background: #FFFFFF; border: 2px solid #0D0D0D; color: #0D0D0D;"
          />
        </div>

        <!-- Preferences / notes -->
        <div class="space-y-1.5">
          <label for="input-preferencias" class="text-sm font-bold" style="color: #0D0D0D;">
            ğŸ“ Preferencias o aclaraciones
          </label>
          <textarea
            id="input-preferencias"
            placeholder="Ej: Sin cebolla, sin pepino, extra salsa..."
            rows="2"
            class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all resize-none"
            style="background: #FFFFFF; border: 2px solid #0D0D0D; color: #0D0D0D;"
          ></textarea>
        </div>

        <!-- Payment method -->
        <div class="space-y-1.5">
          <label for="select-pago" class="text-sm font-bold" style="color: #0D0D0D;">
            ğŸ’³ MÃ©todo de Pago
          </label>
          <div class="relative">
            <select
              id="select-pago"
              class="w-full px-4 py-3 rounded-xl text-sm outline-none appearance-none cursor-pointer transition-all"
              style="background: #FFFFFF; border: 2px solid #0D0D0D; color: #0D0D0D;"
            >
              <option value="efectivo">ğŸ’µ Efectivo</option>
              <option value="mercadopago">ğŸ“± Mercado Pago (Alias/CVU)</option>
              <option value="transferencia">ğŸ¦ Transferencia Bancaria</option>
            </select>
            <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none" style="color: #E8681A;">â–¼</div>
          </div>
        </div>

      </div>

      <!-- Footer: confirm button -->
      <div class="px-5 py-4 flex-shrink-0" style="border-top: 2px solid #0D0D0D; background: #F5F0E8;">
        <button
          id="confirm-whatsapp-btn"
          class="w-full py-4 rounded-2xl font-black text-base flex items-center justify-center gap-3 transition-all duration-200 active:scale-95"
          style="background: #25D366; color: #0D0D0D; border: 2.5px solid #0D0D0D; box-shadow: 4px 4px 0px #0D0D0D; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 0.04em;"
        >
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
          </svg>
          Confirmar y Enviar a WhatsApp
        </button>
      </div>
    </div>
  </div>

  <!-- Floating cart button -->
  <div id="cart-float" class="fixed bottom-6 right-4 z-50" style="display: none !important;">
    <button
      id="cart-btn"
      class="flex items-center gap-3 px-5 py-3.5 rounded-2xl font-black text-sm shadow-2xl transition-all duration-300 active:scale-95 select-none"
      style="background: #E8681A; color: #0D0D0D; border: 2.5px solid #0D0D0D; box-shadow: 5px 5px 0px #0D0D0D;"
      aria-label="Ver carrito y finalizar pedido"
    >
      <div class="relative">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
        </svg>
        <span
          id="cart-count-badge"
          class="absolute -top-2 -right-2 w-5 h-5 rounded-full flex items-center justify-center text-xs font-black"
          style="background: #0D0D0D; color: #E8681A; border: 1.5px solid #0D0D0D;"
        >0</span>
      </div>
      <div class="flex flex-col items-start leading-none">
        <span class="text-xs font-semibold opacity-80">Tu pedido</span>
        <span id="cart-total-display" class="text-base font-black">$0</span>
      </div>
    </button>
  </div>

</div>

<script>
  import { cartItems, removeFromCart, clearCart } from '../stores/cartStore.js';

  const rootElement = document.getElementById('cart-component-root');
  const WHATSAPP_NUMBER = rootElement.dataset.whatsapp;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHIPPING CONFIGURATION
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // DirecciÃ³n del local (origen fijo)
  const ORIGIN_ADDRESS = 'Queirel 5623, Posadas, Misiones, Argentina';

  // Google Sheet de configuraciÃ³n publicado como CSV.
  // El dueÃ±o crea un Sheet con columnas: clave | valor
  // Fila 1: tarifa_por_km | 500
  // Fila 2: min_envio     | 1500
  // Luego: Archivo â†’ Compartir â†’ Publicar en la web â†’ CSV â†’ copiar URL
  // TODO: reemplazar '' con la URL real
  const CONFIG_SHEET_CSV_URL = '';

  // Valores de fallback si el Sheet no estÃ¡ configurado o falla
  const FALLBACK_TARIFA_POR_KM = 500;  // ARS por km
  const FALLBACK_MIN_ENVIO     = 1500; // ARS mÃ­nimo de envÃ­o

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // STATE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  let currentItems      = [];
  let deliveryType      = 'delivery';
  let currentShipping   = 0;      // ARS â€” calculado dinÃ¡micamente
  let shippingCalcDone  = false;  // true cuando el usuario calculÃ³ el envÃ­o
  let calculatedKm      = null;   // km resultante del Ãºltimo cÃ¡lculo
  let tarifaCache       = null;   // { tarifaPorKm, minEnvio } â€” cacheado en memoria

  // Coordenadas del local (se geocodifican una vez, al cargar la pÃ¡gina)
  let originCoords = null; // { lat, lon }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DOM REFS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const cartFloat        = document.getElementById('cart-float');
  const cartBtn          = document.getElementById('cart-btn');
  const cartCountBadge   = document.getElementById('cart-count-badge');
  const cartTotalDisplay = document.getElementById('cart-total-display');

  const modalOverlay    = document.getElementById('checkout-modal-overlay');
  const modalCloseBtn   = document.getElementById('modal-close-btn');
  const modalItemsList  = document.getElementById('modal-items-list');
  const modalSubtotal   = document.getElementById('modal-subtotal');
  const modalShipCost   = document.getElementById('modal-shipping-cost');
  const shippingRow     = document.getElementById('shipping-cost-row');
  const modalTotal      = document.getElementById('modal-total');
  const confirmBtn      = document.getElementById('confirm-whatsapp-btn');
  const clearCartBtn    = document.getElementById('clear-cart-btn');

  const toggleDelivery  = document.getElementById('toggle-delivery');
  const toggleRetiro    = document.getElementById('toggle-retiro');
  const fieldDelivery   = document.getElementById('field-delivery');
  const fieldRetiro     = document.getElementById('field-retiro');
  const inputDireccion  = document.getElementById('input-direccion');
  const inputNombre     = document.getElementById('input-nombre');
  const inputPref       = document.getElementById('input-preferencias');
  const selectPago      = document.getElementById('select-pago');
  const calcEnvioBtn    = document.getElementById('calc-envio-btn');
  const shippingResult  = document.getElementById('shipping-result');

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // HELPERS â€” FORMAT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function formatPrice(amount) {
    return new Intl.NumberFormat('es-AR', {
      style: 'currency',
      currency: 'ARS',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(amount);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHIPPING â€” CONFIG FETCH (Google Sheets CSV)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function fetchTarifa() {
    if (tarifaCache) return tarifaCache;

    if (!CONFIG_SHEET_CSV_URL || CONFIG_SHEET_CSV_URL.trim() === '') {
      console.warn('[shipping] CONFIG_SHEET_CSV_URL no configurada. Usando valores de fallback.');
      tarifaCache = { tarifaPorKm: FALLBACK_TARIFA_POR_KM, minEnvio: FALLBACK_MIN_ENVIO };
      return tarifaCache;
    }

    try {
      const res  = await fetch(CONFIG_SHEET_CSV_URL);
      const text = await res.text();
      const rows = text.trim().split('\n').slice(1); // skip header

      let tarifaPorKm = FALLBACK_TARIFA_POR_KM;
      let minEnvio    = FALLBACK_MIN_ENVIO;

      rows.forEach(row => {
        const [clave, valor] = row.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
        if (clave === 'tarifa_por_km') tarifaPorKm = parseFloat(valor) || FALLBACK_TARIFA_POR_KM;
        if (clave === 'min_envio')     minEnvio    = parseFloat(valor) || FALLBACK_MIN_ENVIO;
      });

      tarifaCache = { tarifaPorKm, minEnvio };
      return tarifaCache;
    } catch (err) {
      console.warn('[shipping] Error al leer config del Sheet:', err);
      tarifaCache = { tarifaPorKm: FALLBACK_TARIFA_POR_KM, minEnvio: FALLBACK_MIN_ENVIO };
      return tarifaCache;
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHIPPING â€” GEOCODING (Nominatim / OpenStreetMap)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function geocodeAddress(address) {
    const encoded = encodeURIComponent(address);
    const url = `https://nominatim.openstreetmap.org/search?q=${encoded}&format=json&limit=1&countrycodes=ar`;
    const res = await fetch(url, {
      headers: { 'Accept-Language': 'es', 'User-Agent': 'BrancoDeliveryApp/1.0' }
    });
    const data = await res.json();
    if (!data || data.length === 0) throw new Error('DirecciÃ³n no encontrada');
    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHIPPING â€” ROUTING (OSRM public instance)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function getRoutingDistanceKm(origin, dest) {
    // OSRM expects lon,lat order
    const url = `https://router.project-osrm.org/route/v1/driving/${origin.lon},${origin.lat};${dest.lon},${dest.lat}?overview=false`;
    const res  = await fetch(url);
    const data = await res.json();
    if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
      throw new Error('No se pudo calcular la ruta');
    }
    const meters = data.routes[0].distance;
    return Math.round((meters / 1000) * 10) / 10; // km con 1 decimal
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHIPPING â€” UI STATE HELPERS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function setShippingResultUI(state, payload = {}) {
    shippingResult.style.display = 'block';

    if (state === 'loading') {
      shippingResult.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:#FFFFFF;border:2px solid #0D0D0D;border-radius:12px;">
          <span style="display:inline-block;width:18px;height:18px;border:3px solid #E8681A;border-top-color:transparent;border-radius:50%;animation:spin 0.7s linear infinite;flex-shrink:0;"></span>
          <span style="font-size:0.85rem;font-weight:600;color:#6B6660;">Calculando distancia...</span>
        </div>
        <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
      `;
    } else if (state === 'success') {
      const { km, price } = payload;
      shippingResult.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:#FFFFFF;border:2px solid #0D0D0D;border-radius:12px;box-shadow:3px 3px 0px #E8681A;">
          <span style="font-size:1.3rem;flex-shrink:0;">âœ…</span>
          <div style="flex:1;">
            <p style="font-size:0.8rem;color:#6B6660;font-weight:600;margin:0 0 2px;">Distancia estimada</p>
            <p style="font-family:'Bebas Neue',sans-serif;font-size:1rem;color:#0D0D0D;letter-spacing:0.04em;margin:0;">
              ${km} km â†’ <span style="color:#E8681A;">${formatPrice(price)}</span>
            </p>
          </div>
        </div>
      `;
    } else if (state === 'error') {
      const { msg } = payload;
      shippingResult.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:#FFF0EE;border:2px solid #E8681A;border-radius:12px;">
          <span style="font-size:1.3rem;flex-shrink:0;">âš ï¸</span>
          <p style="font-size:0.82rem;font-weight:600;color:#0D0D0D;margin:0;">${msg}</p>
        </div>
      `;
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHIPPING â€” MAIN CALCULATE FUNCTION
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function calcularEnvio() {
    const address = inputDireccion?.value?.trim();
    if (!address) {
      setShippingResultUI('error', { msg: 'IngresÃ¡ tu direcciÃ³n antes de calcular.' });
      return;
    }

    setShippingResultUI('loading');
    calcEnvioBtn.disabled = true;
    calcEnvioBtn.style.opacity = '0.6';

    try {
      // 1. Geocode origin once (cached)
      if (!originCoords) {
        originCoords = await geocodeAddress(ORIGIN_ADDRESS);
      }

      // 2. Geocode destination
      // Try with "Posadas, Misiones" appended if not already mentioned
      const fullAddress = /posadas|misiones/i.test(address) ? address : `${address}, Posadas, Misiones, Argentina`;
      const destCoords = await geocodeAddress(fullAddress);

      // 3. Get driving distance
      const km = await getRoutingDistanceKm(originCoords, destCoords);

      // 4. Fetch tarifa
      const { tarifaPorKm, minEnvio } = await fetchTarifa();

      // 5. Calculate price
      const rawPrice = km * tarifaPorKm;
      const price    = Math.ceil(Math.max(rawPrice, minEnvio) / 50) * 50; // round up to nearest 50

      // 6. Update state
      currentShipping  = price;
      shippingCalcDone = true;
      calculatedKm     = km;

      setShippingResultUI('success', { km, price });
      updateModalTotals();

    } catch (err) {
      console.warn('[shipping] Error:', err);
      shippingCalcDone = false;
      currentShipping  = 0;
      setShippingResultUI('error', {
        msg: 'No pudimos calcular la distancia. ProbÃ¡ con una direcciÃ³n mÃ¡s detallada (ej: Av. ColÃ³n 1234, CÃ³rdoba).'
      });
      updateModalTotals();
    } finally {
      calcEnvioBtn.disabled = false;
      calcEnvioBtn.style.opacity = '1';
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MODAL TOTALS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function getShippingCost() {
    if (deliveryType !== 'delivery') return 0;
    return currentShipping;
  }

  function updateModalTotals() {
    const subtotal = currentItems.reduce((s, i) => s + i.precio * i.qty, 0);
    const shipping = getShippingCost();
    const total    = subtotal + shipping;

    if (modalSubtotal) modalSubtotal.textContent = formatPrice(subtotal);
    if (modalTotal)    modalTotal.textContent    = formatPrice(total);

    if (deliveryType === 'delivery') {
      if (shippingRow)   { shippingRow.style.removeProperty('display'); shippingRow.style.display = 'flex'; }
      if (modalShipCost) modalShipCost.textContent = shippingCalcDone ? formatPrice(shipping) : 'Por calcular';
    } else {
      if (shippingRow) shippingRow.style.display = 'none';
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RENDER ITEMS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function renderItems() {
    modalItemsList.innerHTML = currentItems.map(item => `
      <li class="flex items-center gap-2" data-item-id="${item.id}">
        <div class="flex items-center gap-1 flex-shrink-0">
          <button class="cart-qty-btn w-6 h-6 flex items-center justify-center font-black text-sm leading-none transition-all active:scale-90"
            data-action="dec" data-id="${item.id}"
            style="background:#F5F0E8;color:#0D0D0D;border:1.5px solid #0D0D0D;box-shadow:2px 2px 0px #E8681A;">âˆ’</button>
          <span class="text-xs font-black w-5 text-center" style="color:#0D0D0D;">${item.qty}</span>
          <button class="cart-qty-btn w-6 h-6 flex items-center justify-center font-black text-sm leading-none transition-all active:scale-90"
            data-action="inc" data-id="${item.id}"
            style="background:#E8681A;color:#0D0D0D;border:1.5px solid #0D0D0D;box-shadow:2px 2px 0px #0D0D0D;">+</button>
        </div>
        <span class="text-sm flex-1 truncate" style="color:#0D0D0D;font-weight:600;">${item.nombre}</span>
        <span style="font-family:'Bebas Neue',sans-serif;font-size:1.05rem;color:#E8681A;flex-shrink:0;">${formatPrice(item.precio * item.qty)}</span>
        <button class="cart-remove-btn w-6 h-6 flex items-center justify-center flex-shrink-0 transition-all active:scale-90"
          data-id="${item.id}"
          style="background:#F5F0E8;color:#0D0D0D;border:1.5px solid #0D0D0D;font-size:11px;">âœ•</button>
      </li>
    `).join('');

    // Qty buttons
    modalItemsList.querySelectorAll('.cart-qty-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        if (btn.dataset.action === 'dec') {
          removeFromCart(id);
        } else {
          import('../stores/cartStore.js').then(({ addToCart }) => {
            const item = currentItems.find(i => i.id === id);
            if (item) addToCart({ id: item.id, nombre: item.nombre, precio: item.precio });
          });
        }
      });
    });

    // Remove-all buttons
    modalItemsList.querySelectorAll('.cart-remove-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id   = btn.dataset.id;
        const item = currentItems.find(i => i.id === id);
        if (!item) return;
        for (let i = 0; i < item.qty; i++) removeFromCart(id);
      });
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MODAL OPEN / CLOSE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function openModal() {
    const count = currentItems.reduce((s, i) => s + i.qty, 0);
    if (count === 0) return;

    renderItems();
    updateModalTotals();

    modalOverlay.style.removeProperty('display');
    modalOverlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // Pre-geocode the origin address in the background so the first calculation is faster
    if (!originCoords) {
      geocodeAddress(ORIGIN_ADDRESS).then(c => { originCoords = c; }).catch(() => {});
    }
  }

  function closeModal() {
    modalOverlay.style.display = 'none';
    document.body.style.overflow = '';
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DELIVERY TYPE TOGGLE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function setDeliveryType(type) {
    deliveryType = type;

    if (type === 'delivery') {
      toggleDelivery.style.background = '#E8681A';
      toggleDelivery.style.color      = '#0D0D0D';
      toggleDelivery.style.boxShadow  = '3px 3px 0px #0D0D0D';
      toggleRetiro.style.background   = '#F5F0E8';
      toggleRetiro.style.color        = '#6B6660';
      toggleRetiro.style.boxShadow    = '3px 3px 0px #0D0D0D';
      fieldDelivery.classList.remove('hidden');
      fieldRetiro.classList.add('hidden');
    } else {
      // Retiro en local
      toggleRetiro.style.background   = '#E8681A';
      toggleRetiro.style.color        = '#0D0D0D';
      toggleRetiro.style.boxShadow    = '3px 3px 0px #0D0D0D';
      toggleDelivery.style.background = '#F5F0E8';
      toggleDelivery.style.color      = '#6B6660';
      toggleDelivery.style.boxShadow  = '3px 3px 0px #0D0D0D';
      fieldRetiro.classList.remove('hidden');
      fieldDelivery.classList.add('hidden');

      // Reset shipping when switching to pickup
      currentShipping  = 0;
      shippingCalcDone = false;
      calculatedKm     = null;
    }

    updateModalTotals();
  }

  toggleDelivery?.addEventListener('click', () => setDeliveryType('delivery'));
  toggleRetiro?.addEventListener('click',   () => setDeliveryType('retiro'));

  // Calculate button
  calcEnvioBtn?.addEventListener('click', calcularEnvio);

  // Allow pressing Enter in the address field to trigger calculation
  inputDireccion?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); calcularEnvio(); }
  });

  // If address changes after a calculation, reset the result
  inputDireccion?.addEventListener('input', () => {
    if (shippingCalcDone) {
      shippingCalcDone = false;
      currentShipping  = 0;
      calculatedKm     = null;
      shippingResult.style.display = 'none';
      updateModalTotals();
    }
  });

  // Focus styles
  [inputDireccion, inputNombre, inputPref].forEach(input => {
    if (!input) return;
    input.addEventListener('focus', () => { input.style.borderColor = '#E8681A'; input.style.boxShadow = '3px 3px 0px #E8681A'; });
    input.addEventListener('blur',  () => { input.style.borderColor = '#0D0D0D'; input.style.boxShadow = 'none'; });
  });
  [selectPago].forEach(sel => {
    if (!sel) return;
    sel.addEventListener('focus', () => { sel.style.borderColor = '#E8681A'; sel.style.boxShadow = '3px 3px 0px #E8681A'; });
    sel.addEventListener('blur',  () => { sel.style.borderColor = '#0D0D0D'; sel.style.boxShadow = 'none'; });
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // WHATSAPP MESSAGE BUILDER
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function buildWhatsAppMessage(items) {
    const subtotal = items.reduce((s, i) => s + i.precio * i.qty, 0);
    const shipping = getShippingCost();
    const total    = subtotal + shipping;
    const lines    = items.map(i => `  â€¢ ${i.qty}x ${i.nombre} (${formatPrice(i.precio * i.qty)})`).join('\n');

    const pagoLabels = {
      efectivo:      'ğŸ’µ Efectivo',
      mercadopago:   'ğŸ“± Mercado Pago (Alias/CVU)',
      transferencia: 'ğŸ¦ Transferencia Bancaria',
    };
    const pagoLabel = pagoLabels[selectPago?.value] || 'Efectivo';

    let entregaLine = '';
    if (deliveryType === 'delivery') {
      const dir = inputDireccion?.value?.trim() || '(sin especificar)';
      const kmInfo = calculatedKm !== null ? ` (${calculatedKm} km)` : '';
      entregaLine = `ğŸ›µ *Entrega:* Delivery\nğŸ“ *DirecciÃ³n:* ${dir}${kmInfo}\nğŸ’° *Costo de envÃ­o:* ${formatPrice(shipping)}`;
    } else {
      const nombre = inputNombre?.value?.trim() || '(sin especificar)';
      entregaLine  = `ğŸª *Entrega:* Retiro en Local\nğŸ‘¤ *Nombre:* ${nombre}`;
    }

    const shippingLine = deliveryType === 'delivery'
      ? `\nğŸ’° *Subtotal productos:* ${formatPrice(subtotal)}\nğŸ›µ *EnvÃ­o:* ${formatPrice(shipping)}`
      : '';

    const prefText = inputPref?.value?.trim();
    const prefLine = prefText ? `\n\nğŸ“ *Preferencias:* ${prefText}` : '';

    return `Â¡Hola Branco Burgers! ğŸ”\n\n${entregaLine}\nğŸ’³ *Pago:* ${pagoLabel}\n\nğŸ“‹ *Detalle del pedido:*\n${lines}${shippingLine}${prefLine}\n\n*Total: ${formatPrice(total)}*\n\nÂ¿PodÃ©s confirmarme disponibilidad? Â¡Gracias!`;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CART STORE SUBSCRIPTION
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  cartItems.subscribe((items) => {
    currentItems = items;
    const count = items.reduce((s, i) => s + i.qty, 0);
    const total = items.reduce((s, i) => s + i.precio * i.qty, 0);

    if (count > 0) {
      cartFloat.style.removeProperty('display');
      cartFloat.style.display = 'block';
    } else {
      cartFloat.style.display = 'none';
      closeModal();
    }

    cartCountBadge.textContent   = count;
    cartTotalDisplay.textContent = formatPrice(total);

    // If modal is open, re-render items live
    const isOpen = modalOverlay.style.display === 'flex';
    if (isOpen) {
      renderItems();
      updateModalTotals();
    }
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // EVENTS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  cartBtn?.addEventListener('click', openModal);
  modalCloseBtn?.addEventListener('click', closeModal);

  modalOverlay?.addEventListener('click', (e) => {
    if (e.target === modalOverlay) closeModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });

  confirmBtn?.addEventListener('click', () => {
    if (currentItems.length === 0) return;

    // If delivery, require shipping calculation
    if (deliveryType === 'delivery' && !shippingCalcDone) {
      setShippingResultUI('error', { msg: 'Por favor, calculÃ¡ el costo de envÃ­o antes de confirmar el pedido.' });
      shippingResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      return;
    }

    const message = buildWhatsAppMessage(currentItems);
    const url     = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
    closeModal();
  });

  clearCartBtn?.addEventListener('click', () => {
    if (confirm('Â¿Vaciar el pedido actual?')) {
      clearCart();
    }
  });

  // Pre-fetch tarifa en background al cargar la pÃ¡gina
  fetchTarifa();
</script>