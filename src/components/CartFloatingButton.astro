---
// CartFloatingButton.astro
// TODO: Reemplazar con el nÃºmero de WhatsApp de Branco Burgers (sin + ni espacios, ej: 5491112345678)
const WHATSAPP_NUMBER = "543765085128";
---

<div id="cart-component-root" data-whatsapp={WHATSAPP_NUMBER}>
  <div
    id="checkout-modal-overlay"
    class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4"
    style="background: rgba(0,0,0,0.80); backdrop-filter: blur(4px); display: none !important;"
    aria-modal="true"
    role="dialog"
    aria-labelledby="modal-title"
  >
    <div
      id="checkout-modal"
      class="relative w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl overflow-hidden flex flex-col"
      style="background: #F5F0E8; border: 2px solid #0D0D0D; box-shadow: 6px 6px 0px #E8681A; max-height: 92dvh;"
    >
      <!-- Burger pattern â€” same as body, clipped by modal's overflow:hidden -->
      <div
        aria-hidden="true"
        style="position:absolute;inset:0;z-index:0;pointer-events:none;background-image:url('/img/burger-pattern.png');background-size:320px 320px;background-repeat:repeat;opacity:0.08;mix-blend-mode:multiply;"
      >
      </div>
      <!-- Modal header -->
      <div
        class="flex items-center justify-between px-5 py-4 flex-shrink-0"
        style="border-bottom: 2px solid #0D0D0D;"
      >
        <div>
          <h2
            id="modal-title"
            style="font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; color: #E8681A; letter-spacing: 0.03em;"
          >
            FINALIZAR PEDIDO ğŸ›’
          </h2>
          <p class="text-xs mt-0.5" style="color: #6B6660; font-weight: 600;">
            CompletÃ¡ los datos para tu pedido
          </p>
        </div>
        <button
          id="modal-close-btn"
          class="w-9 h-9 rounded-full flex items-center justify-center text-lg transition-all active:scale-90"
          style="background: #0D0D0D; color: #F5F0E8; border: 1.5px solid #0D0D0D;"
          aria-label="Cerrar modal">âœ•</button
        >
      </div>

      <div class="overflow-y-auto flex-1 px-5 py-4 space-y-5">
        <!-- Order summary -->
        <div
          class="p-4"
          style="background: #FFFFFF; border: 2px solid #0D0D0D; box-shadow: 3px 3px 0px #E8681A;"
        >
          <div class="flex items-center justify-between mb-3">
            <p
              style="font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; color: #0D0D0D; letter-spacing: 0.06em;"
            >
              TU PEDIDO
            </p>
            <button
              id="clear-cart-btn"
              class="text-xs font-bold px-2 py-1 rounded-lg transition-all active:scale-90"
              style="background: #F5F0E8; color: #E8681A; border: 2px solid #0D0D0D;"
            >
              ğŸ—‘ Vaciar pedido
            </button>
          </div>
          <ul id="modal-items-list" class="space-y-2 mb-3"></ul>
          <div
            class="flex items-center justify-between pt-3"
            style="border-top: 1.5px solid #0D0D0D;"
          >
            <span class="text-sm font-bold" style="color: #6B6660;"
              >Subtotal</span
            >
            <span
              id="modal-subtotal"
              class="text-base font-bold"
              style="color: #0D0D0D;"></span>
          </div>
          <!-- Shipping cost row (only visible on delivery) -->
          <div
            id="shipping-cost-row"
            class="flex items-center justify-between pt-2"
            style="display: none !important;"
          >
            <span
              class="text-sm font-bold"
              style="color: #E8681A; font-weight: 800;">ğŸ›µ EnvÃ­o</span
            >
            <span
              id="modal-shipping-cost"
              class="text-base font-bold"
              style="color: #E8681A;"></span>
          </div>
          <!-- Grand total -->
          <div
            class="flex items-center justify-between pt-2 mt-1"
            style="border-top: 2px solid #0D0D0D;"
          >
            <span
              style="font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; color: #0D0D0D;"
              >TOTAL</span
            >
            <span
              id="modal-total"
              style="font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; color: #E8681A;"
            ></span>
          </div>
        </div>

        <!-- Common fields: Name -->
        <div class="space-y-1.5">
          <label
            for="input-nombre"
            class="text-sm font-bold flex items-center gap-1"
            style="color: #0D0D0D;"
          >
            ğŸ‘¤ Tu nombre <span style="color:#E8681A;">*</span>
          </label>
          <input
            id="input-nombre"
            type="text"
            placeholder="Ej: Juan GarcÃ­a"
            class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all"
            style="background: #FFFFFF; border: 2px solid #0D0D0D; color: #0D0D0D;"
            required
          />
        </div>

        <!-- Delivery type -->
        <div>
          <p
            style="font-family: 'Bebas Neue', sans-serif; font-size: 1rem; color: #0D0D0D; letter-spacing: 0.05em; margin-bottom: 10px;"
          >
            TIPO DE ENTREGA
          </p>
          <div class="grid grid-cols-2 gap-2">
            <button
              id="toggle-delivery"
              class="delivery-toggle py-3 px-4 rounded-xl font-bold text-sm transition-all duration-200 flex items-center justify-center gap-2 active:scale-95"
              data-type="delivery"
              style="background: #E8681A; color: #0D0D0D; border: 2px solid #0D0D0D; box-shadow: 3px 3px 0px #0D0D0D; font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; letter-spacing: 0.04em;"
            >
              ğŸ›µ DELIVERY
            </button>
            <button
              id="toggle-retiro"
              class="delivery-toggle py-3 px-4 rounded-xl font-bold text-sm transition-all duration-200 flex items-center justify-center gap-2 active:scale-95"
              data-type="retiro"
              style="background: #F5F0E8; color: #6B6660; border: 2px solid #0D0D0D; box-shadow: 3px 3px 0px #0D0D0D; font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; letter-spacing: 0.04em;"
            >
              ğŸª RETIRO LOCAL
            </button>
          </div>
        </div>

        <!-- Delivery fields -->
        <div id="field-delivery" class="space-y-3">
          <!-- Address field with calculate button -->
          <div class="space-y-1.5">
            <label
              for="input-direccion"
              class="text-sm font-bold"
              style="color: #0D0D0D;"
            >
              ğŸ  DirecciÃ³n completa
            </label>
            <input
              id="input-direccion"
              type="text"
              placeholder="Ej: Av. ColÃ³n 1234, CÃ³rdoba"
              class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all"
              style="background: #FFFFFF; border: 2px solid #0D0D0D; color: #0D0D0D;"
              autocomplete="off"
            />
            <div class="flex gap-2">
              <button
                id="calc-envio-btn"
                class="flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-200 flex items-center justify-center gap-2 active:scale-95"
                style="background: #0D0D0D; color: #F5F0E8; border: 2px solid #0D0D0D; box-shadow: 3px 3px 0px #E8681A; font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem; letter-spacing: 0.04em;"
              >
                ğŸ“ Calcular envÃ­o
              </button>
              <button
                id="toggle-map-btn"
                class="py-3 px-3 rounded-xl font-bold text-sm transition-all duration-200 flex items-center justify-center active:scale-95"
                style="background: #F5F0E8; color: #0D0D0D; border: 2px solid #0D0D0D; box-shadow: 3px 3px 0px #E8681A; font-size: 1.1rem;"
                title="Elegir en el mapa"
                aria-label="Abrir mapa"
              >
                ğŸ—ºï¸
              </button>
            </div>
          </div>

          <!-- Map container (lazy-loaded Leaflet) -->
          <div
            id="map-container"
            style="display:none; border: 2px solid #0D0D0D; border-radius: 12px; overflow: hidden; box-shadow: 3px 3px 0px #E8681A;"
          >
            <div
              style="background:#0D0D0D; padding: 8px 12px; display:flex; align-items:center; justify-content:between; gap:8px;"
            >
              <p
                style="font-family:'Bebas Neue',sans-serif; font-size:0.85rem; color:#F5F0E8; letter-spacing:0.04em; flex:1;"
              >
                ğŸ—ºï¸ ARRASTRÃ EL PIN AZUL A TU DIRECCIÃ“N
              </p>
              <button
                id="close-map-btn"
                style="background:transparent; color:#E8681A; font-size:1rem; font-weight:900; border:none; cursor:pointer; padding:0 4px;"
                >âœ•</button
              >
            </div>
            <div
              id="leaflet-map"
              style="height: 280px; width: 100%; z-index: 1;"
            >
            </div>
            <div
              style="padding:8px 12px; background:#F5F0E8; border-top:1.5px solid #0D0D0D; display:flex; align-items:center; gap:8px;"
            >
              <span
                style="font-size:0.75rem; color:#6B6660; font-weight:600; flex:1;"
                >ğŸ”´ Branco Burgers &nbsp;Â·&nbsp; ğŸ“ Tu ubicaciÃ³n (arrastrÃ¡)</span
              >
            </div>
          </div>

          <!-- Shipping result panel -->
          <div id="shipping-result" style="display: none;">
            <!-- Populated by JS: states = loading | success | error -->
          </div>
        </div>

        <!-- Payment method -->
        <div class="space-y-3">
          <div class="space-y-1.5">
            <label
              for="select-pago"
              class="text-sm font-bold"
              style="color: #0D0D0D;"
            >
              ğŸ’³ MÃ©todo de Pago
            </label>
            <div class="relative">
              <select
                id="select-pago"
                class="w-full px-4 py-3 rounded-xl text-sm outline-none appearance-none cursor-pointer transition-all"
                style="background: #FFFFFF; border: 2px solid #0D0D0D; color: #0D0D0D;"
              >
                <option value="efectivo">ğŸ’µ Efectivo</option>
                <option value="mercadopago">ğŸ“± Mercado Pago (Alias/CVU)</option>
                <option value="transferencia">ğŸ¦ Transferencia Bancaria</option>
              </select>
              <div
                class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none"
                style="color: #E8681A;"
              >
                â–¼
              </div>
            </div>
          </div>

          <!-- Cash change field (hidden by default) -->
          <div id="field-vuelto" class="space-y-1.5" style="display: none;">
            <label
              for="input-pago-con"
              class="text-sm font-bold"
              style="color: #0D0D0D;"
            >
              ğŸ’¸ Â¿Con cuÃ¡nto pagÃ¡s?
            </label>
            <input
              id="input-pago-con"
              type="number"
              inputmode="numeric"
              placeholder="Ej: 5000"
              class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all"
              style="background: #FFFFFF; border: 2px solid #0D0D0D; color: #0D0D0D;"
            />
            <p class="text-[10px] italic" style="color: #6B6660;">
              IngresÃ¡ el monto para que el repartidor lleve vuelto.
            </p>
          </div>
        </div>
      </div>

      <!-- Footer: confirm button -->
      <div
        class="px-5 py-4 flex-shrink-0"
        style="border-top: 2px solid #0D0D0D; background: #F5F0E8;"
      >
        <button
          id="confirm-whatsapp-btn"
          class="w-full py-4 rounded-2xl font-black text-base flex items-center justify-center gap-3 transition-all duration-200 active:scale-95"
          style="background: #25D366; color: #0D0D0D; border: 2.5px solid #0D0D0D; box-shadow: 4px 4px 0px #0D0D0D; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 0.04em;"
        >
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"
            ></path>
          </svg>
          Confirmar y Enviar a WhatsApp
        </button>
      </div>
    </div>
  </div>

  <!-- Floating cart button -->
  <div
    id="cart-float"
    class="fixed bottom-6 right-4 z-50"
    style="display: none !important;"
  >
    <button
      id="cart-btn"
      class="flex items-center gap-3 px-5 py-3.5 rounded-2xl font-black text-sm shadow-2xl transition-all duration-300 active:scale-95 select-none"
      style="background: #E8681A; color: #0D0D0D; border: 2.5px solid #0D0D0D; box-shadow: 5px 5px 0px #0D0D0D;"
      aria-label="Ver carrito y finalizar pedido"
    >
      <div class="relative">
        <svg
          width="22"
          height="22"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2.5"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"
          ></circle>
          <path
            d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"
          ></path>
        </svg>
        <span
          id="cart-count-badge"
          class="absolute -top-2 -right-2 w-5 h-5 rounded-full flex items-center justify-center text-xs font-black"
          style="background: #0D0D0D; color: #E8681A; border: 1.5px solid #0D0D0D;"
          >0</span
        >
      </div>
      <div class="flex flex-col items-start leading-none">
        <span class="text-xs font-semibold opacity-80">Tu pedido</span>
        <span id="cart-total-display" class="text-base font-black">$0</span>
      </div>
    </button>
  </div>
</div>

<script>
  import { cartItems, removeFromCart, clearCart } from "../stores/cartStore.js";

  const rootElement = document.getElementById("cart-component-root");
  const WHATSAPP_NUMBER = rootElement.dataset.whatsapp;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHIPPING CONFIGURATION
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // DirecciÃ³n del local (origen fijo)
  const ORIGIN_ADDRESS = "Queirel 5623, Posadas, Misiones, Argentina";

  // â”€â”€ GOOGLE SHEET UNIFICADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // El dueÃ±o maneja UN solo Google Sheet con DOS pestaÃ±as:
  //   PestaÃ±a 1 â†’ "Menu"   (ya configurada en googleSheets.js)
  //   PestaÃ±a 2 â†’ "Config" (columnas: clave | valor)
  //       Fila 1: tarifa_por_km | 500
  //       Fila 2: min_envio     | 1500
  //
  // Para obtener la URL de Config:
  //   1. Ir a la pestaÃ±a "Config" del Sheet
  //   2. Archivo â†’ Compartir â†’ Publicar en la web â†’ Esta hoja â†’ CSV â†’ Publicar
  //   3. Copiar esa URL y pegarla abajo
  // TODO: reemplazar '' con la URL CSV de la pestaÃ±a Config
  const CONFIG_SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRUjYQ79c41cWdRQw_Ihm4UGnrzuxBIq9CIOQkVCIYsKku595csG9qypXFaaSpYABlRB2lqZ2hMxWjq/pub?gid=1210040946&output=csv";

  // Valores de fallback si el Sheet no estÃ¡ configurado o falla
  const FALLBACK_TARIFA_POR_KM = 500; // ARS por km
  const FALLBACK_MIN_ENVIO = 1500; // ARS mÃ­nimo de envÃ­o

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // STATE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  let currentItems = [];
  let deliveryType = "delivery";
  let currentShipping = 0; // ARS â€” calculado dinÃ¡micamente
  let shippingCalcDone = false; // true cuando el usuario calculÃ³ el envÃ­o
  let calculatedKm = null; // km resultante del Ãºltimo cÃ¡lculo
  let tarifaCache = null; // Array<{ km, price }> â€” cacheado en memoria

  // Coordenadas del local (se geocodifican una vez, al cargar la pÃ¡gina)
  let originCoords = null; // { lat, lon }

  // Mapa
  let mapInitialized = false; // Leaflet inicializado
  let clientMarker = null; // marker arrastrable del cliente
  let pendingDestCoords = null; // { lat, lon } desde el mapa (evita re-geocodificar)

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DOM REFS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const cartFloat = document.getElementById("cart-float");
  const cartBtn = document.getElementById("cart-btn");
  const cartCountBadge = document.getElementById("cart-count-badge");
  const cartTotalDisplay = document.getElementById("cart-total-display");

  const modalOverlay = document.getElementById("checkout-modal-overlay");
  const modalCloseBtn = document.getElementById("modal-close-btn");
  const modalItemsList = document.getElementById("modal-items-list");
  const modalSubtotal = document.getElementById("modal-subtotal");
  const modalShipCost = document.getElementById("modal-shipping-cost");
  const shippingRow = document.getElementById("shipping-cost-row");
  const modalTotal = document.getElementById("modal-total");
  const confirmBtn = document.getElementById("confirm-whatsapp-btn");
  const clearCartBtn = document.getElementById("clear-cart-btn");

  const toggleDelivery = document.getElementById("toggle-delivery");
  const toggleRetiro = document.getElementById("toggle-retiro");
  const fieldDelivery = document.getElementById("field-delivery");
  // fieldRetiro removed as 'Nombre' is now common
  const inputDireccion = document.getElementById("input-direccion");
  const inputNombre = document.getElementById("input-nombre");

  const selectPago = document.getElementById("select-pago");
  const calcEnvioBtn = document.getElementById("calc-envio-btn");
  const shippingResult = document.getElementById("shipping-result");
  const toggleMapBtn = document.getElementById("toggle-map-btn");
  const closeMapBtn = document.getElementById("close-map-btn");
  const mapContainer = document.getElementById("map-container");
  const fieldVuelto = document.getElementById("field-vuelto");
  const inputPagoCon = document.getElementById("input-pago-con");

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // HELPERS â€” FORMAT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function formatPrice(amount) {
    return new Intl.NumberFormat("es-AR", {
      style: "currency",
      currency: "ARS",
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(amount);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHIPPING â€” CONFIG FETCH (Google Sheets CSV)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function fetchTarifasTable() {
    if (tarifaCache) return tarifaCache;

    if (!CONFIG_SHEET_CSV_URL || CONFIG_SHEET_CSV_URL.trim() === "") {
      console.warn("[shipping] CONFIG_SHEET_CSV_URL no configurada.");
      return [];
    }

    try {
      const res = await fetch(CONFIG_SHEET_CSV_URL);
      const text = await res.text();
      const rows = text.trim().split("\n").slice(1); // skip header

      const table = [];
      rows.forEach((row) => {
        const delimiter = row.includes(";") ? ";" : ",";
        const parts = row.split(delimiter).map(s => s.trim().replace(/^"|"$/g, ""));

        if (parts.length >= 2) {
          const km = parseFloat(parts[0].replace(",", "."));
          const price = parseFloat(parts[1].replace(".", "").replace(",", "."));
          if (!isNaN(km) && !isNaN(price)) {
            table.push({ km, price });
          }
        }
      });

      tarifaCache = table.sort((a, b) => a.km - b.km);
      return tarifaCache;
    } catch (err) {
      console.warn("[shipping] Error al leer tabla de tarifas:", err);
      return [];
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHIPPING â€” GEOCODING (Nominatim / OpenStreetMap)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function geocodeAddress(address) {
    const encoded = encodeURIComponent(address);
    const url = `https://nominatim.openstreetmap.org/search?q=${encoded}&format=json&limit=1&countrycodes=ar`;
    const res = await fetch(url, {
      headers: {
        "Accept-Language": "es",
        "User-Agent": "BrancoDeliveryApp/1.0",
      },
    });
    const data = await res.json();
    if (!data || data.length === 0) throw new Error("DirecciÃ³n no encontrada");
    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHIPPING â€” ROUTING (OSRM public instance)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function getRoutingDistanceKm(origin, dest) {
    // OSRM expects lon,lat order
    const url = `https://router.project-osrm.org/route/v1/driving/${origin.lon},${origin.lat};${dest.lon},${dest.lat}?overview=false`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.code !== "Ok" || !data.routes || data.routes.length === 0) {
      throw new Error("No se pudo calcular la ruta");
    }
    const meters = data.routes[0].distance;
    return Math.round((meters / 1000) * 10) / 10; // km con 1 decimal
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHIPPING â€” UI STATE HELPERS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function setShippingResultUI(state, payload = {}) {
    shippingResult.style.display = "block";

    if (state === "loading") {
      shippingResult.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:#FFFFFF;border:2px solid #0D0D0D;border-radius:12px;">
          <span style="display:inline-block;width:18px;height:18px;border:3px solid #E8681A;border-top-color:transparent;border-radius:50%;animation:spin 0.7s linear infinite;flex-shrink:0;"></span>
          <span style="font-size:0.85rem;font-weight:600;color:#6B6660;">Calculando distancia...</span>
        </div>
        <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
      `;
    } else if (state === "success") {
      const { km, price } = payload;
      shippingResult.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:#FFFFFF;border:2px solid #0D0D0D;border-radius:12px;box-shadow:3px 3px 0px #E8681A;">
          <span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;background:#E8681A;border:2px solid #0D0D0D;border-radius:6px;box-shadow:2px 2px 0px #0D0D0D;flex-shrink:0;">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="#F5F0E8" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="2,7 5.5,10.5 12,3.5"/></svg>
          </span>
          <div style="flex:1;">
            <p style="font-size:0.8rem;color:#6B6660;font-weight:600;margin:0 0 2px;">Distancia estimada</p>
            <p style="font-family:'Bebas Neue',sans-serif;font-size:1rem;color:#0D0D0D;letter-spacing:0.04em;margin:0;">
              ${km} km â†’ <span style="color:#E8681A;">${formatPrice(
        price
      )}</span>
            </p>
          </div>
        </div>
      `;
    } else if (state === "error") {
      const { msg } = payload;
      shippingResult.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:#FFF0EE;border:2px solid #E8681A;border-radius:12px;">
          <span style="font-size:1.3rem;flex-shrink:0;">âš ï¸</span>
          <p style="font-size:0.82rem;font-weight:600;color:#0D0D0D;margin:0;">${msg}</p>
        </div>
      `;
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHIPPING â€” MAIN CALCULATE FUNCTION
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function calcularEnvio() {
    const address = inputDireccion?.value?.trim();
    if (!address && !pendingDestCoords) {
      setShippingResultUI("error", {
        msg: "IngresÃ¡ tu direcciÃ³n antes de calcular.",
      });
      return;
    }

    setShippingResultUI("loading");
    calcEnvioBtn.disabled = true;
    calcEnvioBtn.style.opacity = "0.6";

    try {
      // 1. Geocode origin once (cached)
      if (!originCoords) {
        originCoords = await geocodeAddress(ORIGIN_ADDRESS);
      }

      // 2. Dest coords: use pin from map if available, otherwise geocode the text
      let destCoords;
      if (pendingDestCoords) {
        destCoords = pendingDestCoords;
        pendingDestCoords = null; // consume
      } else {
        const fullAddress = /posadas|misiones/i.test(address)
          ? address
          : `${address}, Posadas, Misiones, Argentina`;
        destCoords = await geocodeAddress(fullAddress);
      }

      // 3. Get driving distance
      const km = await getRoutingDistanceKm(originCoords, destCoords);

      // 5. Fetch table and find price tier
      const table = await fetchTarifasTable();
      if (table.length === 0) throw new Error("Tabla de tarifas vacÃ­a");

      const tier = table.find((t) => km <= t.km);

      if (!tier) {
        setShippingResultUI("error", {
          msg: `ğŸ˜” No tenemos entrega disponible para esa distancia (${km} km).`,
        });
        shippingCalcDone = false;
        currentShipping = 0;
        calculatedKm = null;
        updateModalTotals();
        return;
      }

      const price = tier.price;

      // 6. Update state
      currentShipping = price;
      shippingCalcDone = true;
      calculatedKm = km;

      setShippingResultUI("success", { km, price });
      updateModalTotals();
    } catch (err) {
      console.warn("[shipping] Error:", err);
      shippingCalcDone = false;
      currentShipping = 0;
      setShippingResultUI("error", {
        msg: "No pudimos calcular la distancia. ProbÃ¡ con una direcciÃ³n mÃ¡s detallada (ej: Av. San MartÃ­n 1234, Posadas).",
      });
      updateModalTotals();
    } finally {
      calcEnvioBtn.disabled = false;
      calcEnvioBtn.style.opacity = "1";
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MODAL TOTALS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function getShippingCost() {
    if (deliveryType !== "delivery") return 0;
    return currentShipping;
  }

  function updateModalTotals() {
    const subtotal = currentItems.reduce((s, i) => s + i.subtotalItem, 0);
    const shipping = getShippingCost();
    const total = subtotal + shipping;

    if (modalSubtotal) modalSubtotal.textContent = formatPrice(subtotal);
    if (modalTotal) modalTotal.textContent = formatPrice(total);

    if (deliveryType === "delivery") {
      if (shippingRow) {
        shippingRow.style.removeProperty("display");
        shippingRow.style.display = "flex";
      }
      if (modalShipCost)
        modalShipCost.textContent = shippingCalcDone
          ? formatPrice(shipping)
          : "Por calcular";
    } else {
      if (shippingRow) shippingRow.style.display = "none";
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RENDER ITEMS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function renderItems() {
    modalItemsList.innerHTML = currentItems
      .map((item) => {
        // Build extras sub-lines if any
        const extrasHtml =
          item.extras && item.extras.length > 0
            ? item.extras
                .map(
                  (e) => `
          <div class="flex items-center gap-1 ml-8 mt-0.5">
            <span class="text-[10px]" style="color:#E8681A;font-weight:700;">â•</span>
            <span class="text-[11px]" style="color:#6B6660;font-weight:500;">${
              e.nombre
            }</span>
            ${
              e.precio > 0
                ? `<span class="text-[10px]" style="color:#E8681A;font-weight:600;">(${formatPrice(
                    e.precio
                  )})</span>`
                : ""
            }
          </div>
        `
                )
                .join("")
            : "";

        // Build aclaracion sub-line if present
        const aclaracionHtml = item.aclaracion
          ? `
          <div class="flex items-center gap-1 ml-8 mt-0.5">
            <span class="text-[10px]" style="color:#6B6660;font-weight:700;">ğŸ“</span>
            <span class="text-[11px] italic" style="color:#6B6660;font-weight:500;">${item.aclaracion}</span>
          </div>
        `
          : "";

        return `
      <li class="flex flex-col gap-0" data-item-key="${item.cartKey}">
        <div class="flex items-center gap-2">
          <div class="flex items-center gap-1 flex-shrink-0">
            <button class="cart-qty-btn w-6 h-6 flex items-center justify-center font-black text-sm leading-none transition-all active:scale-90"
              data-action="dec" data-key="${item.cartKey}"
              style="background:#F5F0E8;color:#0D0D0D;border:1.5px solid #0D0D0D;box-shadow:2px 2px 0px #E8681A;">âˆ’</button>
            <span class="text-xs font-black w-5 text-center" style="color:#0D0D0D;">${
              item.cantidad
            }</span>
            <button class="cart-qty-btn w-6 h-6 flex items-center justify-center font-black text-sm leading-none transition-all active:scale-90"
              data-action="inc" data-key="${item.cartKey}"
              style="background:#E8681A;color:#0D0D0D;border:1.5px solid #0D0D0D;box-shadow:2px 2px 0px #0D0D0D;">+</button>
          </div>
          <span class="text-sm flex-1 truncate" style="color:#0D0D0D;font-weight:600;">${
            item.nombre
          }</span>
          <span style="font-family:'Bebas Neue',sans-serif;font-size:1.05rem;color:#E8681A;flex-shrink:0;">${formatPrice(
            item.subtotalItem
          )}</span>
          <button class="cart-remove-btn w-6 h-6 flex items-center justify-center flex-shrink-0 transition-all active:scale-90"
            data-key="${item.cartKey}"
            style="background:#F5F0E8;color:#0D0D0D;border:1.5px solid #0D0D0D;font-size:11px;">âœ•</button>
        </div>
        ${extrasHtml}
        ${aclaracionHtml}
      </li>
    `;
      })
      .join("");

    // Qty buttons
    modalItemsList.querySelectorAll(".cart-qty-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const key = btn.dataset.key;
        if (btn.dataset.action === "dec") {
          removeFromCart(key);
        } else {
          import("../stores/cartStore.js").then(({ addToCart }) => {
            const item = currentItems.find((i) => i.cartKey === key);
            if (item)
              addToCart({
                id: item.id_producto,
                nombre: item.nombre,
                precio: item.precioBase,
                extras: item.extras,
                aclaracion: item.aclaracion || "",
              });
          });
        }
      });
    });

    // Remove-all buttons
    modalItemsList.querySelectorAll(".cart-remove-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const key = btn.dataset.key;
        const item = currentItems.find((i) => i.cartKey === key);
        if (!item) return;
        for (let i = 0; i < item.cantidad; i++) removeFromCart(key);
      });
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MODAL OPEN / CLOSE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function openModal() {
    const count = currentItems.reduce((s, i) => s + i.cantidad, 0);
    if (count === 0) return;

    renderItems();
    updateModalTotals();

    modalOverlay.style.removeProperty("display");
    modalOverlay.style.display = "flex";
    document.body.style.overflow = "hidden";

    // Pre-geocode the origin address in the background so the first calculation is faster
    if (!originCoords) {
      geocodeAddress(ORIGIN_ADDRESS)
        .then((c) => {
          originCoords = c;
        })
        .catch(() => {});
    }
  }

  function closeModal() {
    modalOverlay.style.display = "none";
    document.body.style.overflow = "";
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DELIVERY TYPE TOGGLE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function setDeliveryType(type) {
    deliveryType = type;

    function updateDeliveryUI() {
      if (deliveryType === "delivery") {
        toggleDelivery.style.background = "#E8681A";
        toggleDelivery.style.color = "#0D0D0D";
        toggleDelivery.style.boxShadow = "3px 3px 0px #0D0D0D";

        toggleRetiro.style.background = "#F5F0E8";
        toggleRetiro.style.color = "#6B6660";
        toggleRetiro.style.boxShadow = "none";

        fieldDelivery.classList.remove("hidden");
        shippingRow.style.display = "flex";
      } else {
        // Retiro en local
        toggleRetiro.style.background = "#E8681A";
        toggleRetiro.style.color = "#0D0D0D";
        toggleRetiro.style.boxShadow = "3px 3px 0px #0D0D0D";

        toggleDelivery.style.background = "#F5F0E8";
        toggleDelivery.style.color = "#6B6660";
        toggleDelivery.style.boxShadow = "none";

        fieldDelivery.classList.add("hidden");

        // Reset shipping when switching to pickup
        currentShipping = 0;
        shippingCalcDone = false;
        calculatedKm = null;
        if (shippingResult) shippingResult.style.display = "none";
        if (shippingRow) shippingRow.style.display = "none";
      }
      updateModalTotals();
    }

    updateDeliveryUI(); // Call the new UI update function
  }

  toggleDelivery?.addEventListener("click", () => setDeliveryType("delivery"));
  toggleRetiro?.addEventListener("click", () => setDeliveryType("retiro"));

  // Calculate button
  calcEnvioBtn?.addEventListener("click", calcularEnvio);

  // Allow pressing Enter in the address field to trigger calculation
  inputDireccion?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      calcularEnvio();
    }
  });

  // If address changes after a calculation, reset the result
  inputDireccion?.addEventListener("input", () => {
    if (shippingCalcDone) {
      shippingCalcDone = false;
      currentShipping = 0;
      calculatedKm = null;
      shippingResult.style.display = "none";
      updateModalTotals();
    }
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MAP â€” Leaflet (lazy-loaded from CDN)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function loadLeaflet() {
    if (window.L) return; // already loaded
    await new Promise((resolve, reject) => {
      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
      document.head.appendChild(link);

      const script = document.createElement("script");
      script.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  async function initMap() {
    if (mapInitialized) return;
    mapInitialized = true;

    await loadLeaflet();
    const L = window.L;

    // Make sure origin coords are ready
    if (!originCoords) {
      try {
        originCoords = await geocodeAddress(ORIGIN_ADDRESS);
      } catch {
        originCoords = { lat: -27.3671, lon: -55.8975 };
      } // Posadas fallback
    }

    const map = L.map("leaflet-map").setView(
      [originCoords.lat, originCoords.lon],
      14
    );

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap",
      maxZoom: 19,
    }).addTo(map);

    // Fixed red marker for the local
    const redIcon = L.divIcon({
      html: '<div style="width:18px;height:18px;background:#E8681A;border:3px solid #0D0D0D;border-radius:50%;box-shadow:2px 2px 0 #0D0D0D;"></div>',
      iconSize: [18, 18],
      iconAnchor: [9, 9],
      className: "",
    });
    L.marker([originCoords.lat, originCoords.lon], { icon: redIcon })
      .addTo(map)
      .bindPopup(
        '<b style="font-family:sans-serif">ğŸ“ Branco Burgers</b><br><small>Queirel 5623</small>'
      );

    // Draggable blue marker for client â€” starts at center of visible map
    const blueIcon = L.divIcon({
      html: '<div style="width:22px;height:22px;background:#2563EB;border:3px solid #0D0D0D;border-radius:50% 50% 50% 0;transform:rotate(-45deg);box-shadow:2px 2px 0 #0D0D0D;"></div>',
      iconSize: [22, 22],
      iconAnchor: [11, 22],
      className: "",
    });

    const startLat = originCoords.lat + 0.01;
    const startLon = originCoords.lon + 0.01;
    clientMarker = L.marker([startLat, startLon], {
      icon: blueIcon,
      draggable: true,
    })
      .addTo(map)
      .bindPopup(
        '<b style="font-family:sans-serif">ğŸ“ Tu ubicaciÃ³n</b><br><small>ArrastrÃ¡ para ajustar</small>'
      );

    clientMarker.on("dragend", async () => {
      const pos = clientMarker.getLatLng();
      await onPinDrop(pos.lat, pos.lng);
    });

    // Also allow clicking the map to place the client marker
    map.on("click", async (e) => {
      clientMarker.setLatLng(e.latlng);
      await onPinDrop(e.latlng.lat, e.latlng.lng);
    });

    // Fix Leaflet size issue inside hidden containers
    setTimeout(() => map.invalidateSize(), 100);
  }

  async function onPinDrop(lat, lon) {
    // Store coords for the calculator to use directly
    pendingDestCoords = { lat, lon };

    // Reverse-geocode to show the address in the text field
    try {
      const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`;
      const res = await fetch(url, {
        headers: {
          "Accept-Language": "es",
          "User-Agent": "BrancoDeliveryApp/1.0",
        },
      });
      const data = await res.json();
      if (data && data.display_name) {
        // Show a short version: road + house_number + suburb
        const a = data.address || {};
        const parts = [
          a.road,
          a.house_number,
          a.suburb || a.neighbourhood,
          a.city || a.town,
        ].filter(Boolean);
        if (inputDireccion)
          inputDireccion.value = parts.join(", ") || data.display_name;
      }
    } catch {
      /* if reverse geocode fails, keep existing text */
    }

    // Reset previous result and auto-calculate
    shippingCalcDone = false;
    currentShipping = 0;
    calculatedKm = null;
    await calcularEnvio();
  }

  function toggleMap() {
    const isVisible = mapContainer.style.display !== "none";
    if (isVisible) {
      mapContainer.style.display = "none";
      toggleMapBtn.style.background = "#F5F0E8";
      toggleMapBtn.style.color = "#0D0D0D";
    } else {
      mapContainer.style.display = "block";
      toggleMapBtn.style.background = "#E8681A";
      toggleMapBtn.style.color = "#0D0D0D";
      initMap(); // lazy init
    }
  }

  toggleMapBtn?.addEventListener("click", toggleMap);
  closeMapBtn?.addEventListener("click", () => {
    mapContainer.style.display = "none";
    toggleMapBtn.style.background = "#F5F0E8";
    toggleMapBtn.style.color = "#0D0D0D";
  });

  // Focus styles
  [inputDireccion, inputNombre, inputPagoCon].forEach((input) => {
    if (!input) return;
    input.addEventListener("focus", () => {
      input.style.borderColor = "#E8681A";
      input.style.boxShadow = "3px 3px 0px #E8681A";
    });
    input.addEventListener("blur", () => {
      input.style.borderColor = "#0D0D0D";
      input.style.boxShadow = "none";
    });
  });

  selectPago?.addEventListener("change", () => {
    if (selectPago.value === "efectivo") {
      fieldVuelto.style.display = "block";
    } else {
      fieldVuelto.style.display = "none";
      inputPagoCon.value = "";
    }
  });

  // Initial state for cash field
  if (selectPago.value === "efectivo") fieldVuelto.style.display = "block";

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // WHATSAPP MESSAGE BUILDER
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function buildWhatsAppMessage(items) {
    const subtotal = items.reduce((s, i) => s + i.subtotalItem, 0);
    const shipping = getShippingCost();
    const total = subtotal + shipping;

    // Build detail lines â€” with extras and aclaraciones per product
    const lines = items
      .map((i) => {
        let line = `  â€¢ ${i.cantidad}x ${i.nombre} (${formatPrice(
          i.precioBase
        )})`;
        if (i.extras && i.extras.length > 0) {
          const extrasLines = i.extras
            .map(
              (e) =>
                `    â• ${e.nombre}${
                  e.precio > 0 ? ` (${formatPrice(e.precio)})` : ""
                }`
            )
            .join("\n");
          line += "\n" + extrasLines;
        }
        if (i.aclaracion && i.aclaracion.trim()) {
          line += `\n    ğŸ“ AclaraciÃ³n: ${i.aclaracion.trim()}`;
        }
        return line;
      })
      .join("\n");

    const pagoLabels = {
      efectivo: "ğŸ’µ Efectivo",
      mercadopago: "ğŸ“± Mercado Pago (Alias/CVU)",
      transferencia: "ğŸ¦ Transferencia Bancaria",
    };
    const paymentMethod = selectPago?.value || "efectivo";
    const pagoLabel = pagoLabels[paymentMethod] || "Efectivo";

    // Cash details
    let cashLine = "";
    if (paymentMethod === "efectivo") {
      const pagoConVal = parseFloat(inputPagoCon?.value);
      if (pagoConVal > total) {
        const vuelto = pagoConVal - total;
        cashLine = `\nğŸ’° *Paga con:* ${formatPrice(
          pagoConVal
        )}\nğŸª™ *Vuelto:* ${formatPrice(vuelto)}`;
      } else if (pagoConVal === total) {
        cashLine = `\nğŸ’° *Paga con:* ${formatPrice(pagoConVal)} (Justo)`;
      }
    }

    const userName = inputNombre?.value?.trim() || "(sin especificar)";
    let entregaLine = "";
    if (deliveryType === "delivery") {
      const dir = inputDireccion?.value?.trim() || "(sin especificar)";
      const kmInfo = calculatedKm !== null ? ` (${calculatedKm} km)` : "";
      entregaLine = `ğŸ›µ *Entrega:* Delivery\nğŸ‘¤ *Nombre:* ${userName}\nğŸ“ *DirecciÃ³n:* ${dir}${kmInfo}\nğŸ’° *Costo de envÃ­o:* ${formatPrice(
        shipping
      )}`;
    } else {
      entregaLine = `ğŸª *Entrega:* Retiro en Local\nğŸ‘¤ *Nombre:* ${userName}`;
    }

    const shippingLine =
      deliveryType === "delivery"
        ? `\nğŸ’° *Subtotal productos:* ${formatPrice(
            subtotal
          )}\nğŸ›µ *EnvÃ­o:* ${formatPrice(shipping)}`
        : "";

    return `Â¡Hola Branco Burgers! ğŸ”\n\n${entregaLine}\nğŸ’³ *Pago:* ${pagoLabel}${cashLine}\n\nğŸ“‹ *Detalle del pedido:*\n${lines}${shippingLine}\n\n*Total: ${formatPrice(
      total
    )}*\n\nÂ¿PodÃ©s confirmarme disponibilidad? Â¡Gracias!`;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CART STORE SUBSCRIPTION
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  cartItems.subscribe((items) => {
    currentItems = items;
    const count = items.reduce((s, i) => s + i.cantidad, 0);
    const total = items.reduce((s, i) => s + i.subtotalItem, 0);

    if (count > 0) {
      cartFloat.style.removeProperty("display");
      cartFloat.style.display = "block";
    } else {
      cartFloat.style.display = "none";
      closeModal();
    }

    cartCountBadge.textContent = count;
    cartTotalDisplay.textContent = formatPrice(total);

    // If modal is open, re-render items live
    const isOpen = modalOverlay.style.display === "flex";
    if (isOpen) {
      renderItems();
      updateModalTotals();
    }
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // EVENTS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  cartBtn?.addEventListener("click", openModal);
  modalCloseBtn?.addEventListener("click", closeModal);

  modalOverlay?.addEventListener("click", (e) => {
    if (e.target === modalOverlay) closeModal();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
  });

  confirmBtn?.addEventListener("click", () => {
    if (currentItems.length === 0) return;

    // Validation: Name is mandatory for everyone
    if (!inputNombre?.value?.trim()) {
      alert("Por favor, ingresÃ¡ tu nombre para procesar el pedido.");
      inputNombre.focus();
      return;
    }

    // Validation: Delivery specific
    if (deliveryType === "delivery") {
      if (!inputDireccion?.value?.trim()) {
        alert("Por favor, ingresÃ¡ tu direcciÃ³n para el envÃ­o.");
        inputDireccion.focus();
        return;
      }
      if (!shippingCalcDone) {
        setShippingResultUI("error", {
          msg: "Por favor, calculÃ¡ el costo de envÃ­o antes de confirmar.",
        });
        shippingResult.scrollIntoView({ behavior: "smooth", block: "nearest" });
        return;
      }
    }

    // Validation: Pay amount for cash
    if (selectPago?.value === "efectivo") {
      const subtotal = currentItems.reduce((s, i) => s + i.subtotalItem, 0);
      const total =
        subtotal + (deliveryType === "delivery" ? currentShipping : 0);
      const pagoConVal = parseFloat(inputPagoCon?.value);

      if (inputPagoCon?.value?.trim() !== "" && pagoConVal < total) {
        alert(
          `El monto para pagar (${formatPrice(
            pagoConVal
          )}) debe ser igual o mayor al total del pedido (${formatPrice(
            total
          )}).`
        );
        inputPagoCon.focus();
        return;
      }
    }

    const message = buildWhatsAppMessage(currentItems);
    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(
      message
    )}`;
    window.open(url, "_blank");
    closeModal();
  });

  clearCartBtn?.addEventListener("click", () => {
    if (confirm("Â¿Vaciar el pedido actual?")) {
      clearCart();
    }
  });

  // Pre-fetch tarifa en background al cargar la pÃ¡gina
  fetchTarifa();
</script>
