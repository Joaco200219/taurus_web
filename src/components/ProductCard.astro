---
export interface Props {
  id: string;
  nombre: string;
  descripcion: string;
  precio: number;
  imagen: string | null;
  badge?: string | null;
  categoria?: string;
}

const { id, nombre, descripcion, precio, imagen, badge, categoria } =
  Astro.props;

const precioFormateado = new Intl.NumberFormat("es-AR", {
  style: "currency",
  currency: "ARS",
  minimumFractionDigits: 0,
  maximumFractionDigits: 0,
}).format(precio);

// Badge colors — dark mode
const badgeColors: Record<string, { bg: string; text: string }> = {
  NUEVO: { bg: "#D81120", text: "#FFFFFF" },
  OFERTA: { bg: "#D97706", text: "#0A0A0A" },
  ESPECIAL: { bg: "#D81120", text: "#FFFFFF" },
  DOBLE: { bg: "#D97706", text: "#0A0A0A" },
  TRIPLE: { bg: "#333333", text: "#D97706" },
  XXL: { bg: "#D97706", text: "#0A0A0A" },
  PROMO: { bg: "#D97706", text: "#0A0A0A" },
  VEGGIE: { bg: "#4A5D23", text: "#FFFFFF" },
};

const badgeUpper = badge?.toUpperCase() || "";
const badgeStyle =
  badgeUpper && badgeColors[badgeUpper]
    ? badgeColors[badgeUpper]
    : { bg: "#D81120", text: "#FFFFFF" };
---

<!-- Player Card: dark panel, left red border, scoreboard numbers -->
<article
  class="product-card group relative overflow-hidden transition-all duration-200 flex flex-row items-stretch"
  data-product-id={id}
  data-product-nombre={nombre}
  data-product-precio={precio}
  data-product-categoria={categoria || ""}
  style="background: #1E1E1E; border-left: 4px solid #D81120; border-bottom: 1px solid #2A2A2A; padding: 12px 12px 12px 14px; min-height: 88px;"
>
  <!-- LEFT: Info block -->
  <div class="flex-1 min-w-0 flex flex-col justify-between gap-1 pr-3">
    <div>
      <!-- Badge inline if exists -->
      {
        badge && (
          <span
            class="inline-block mb-1"
            style={`background: ${badgeStyle.bg}; color: ${badgeStyle.text}; font-family: 'Anton', sans-serif; font-size: 0.6rem; padding: 1px 6px; letter-spacing: 0.1em; text-transform: uppercase;`}
          >
            {badge}
          </span>
        )
      }
      <!-- Product name — scoreboard style -->
      <h3
        class="product-name"
        style="font-family: 'Anton', sans-serif; color: #FFFFFF; font-size: 1.05rem; line-height: 1.1; letter-spacing: 0.03em; text-transform: uppercase;"
      >
        {nombre}
      </h3>
      <p
        class="text-xs leading-snug mt-1"
        style="color: #A3A3A3; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;"
      >
        {descripcion}
      </p>
    </div>

    <!-- Price — yellow scoreboard -->
    <span
      style="font-family: 'Anton', sans-serif; color: #D97706; font-size: 1.35rem; line-height: 1; letter-spacing: 0.02em;"
    >
      {precioFormateado}
    </span>
  </div>

  <!-- RIGHT: CTA Button — bold block -->
  <div class="flex-shrink-0 flex items-center">
    <button
      class="add-to-cart-btn flex flex-col items-center justify-center transition-all duration-150 active:scale-95 select-none"
      data-product-id={id}
      data-product-nombre={nombre}
      data-product-precio={precio}
      data-product-categoria={categoria || ""}
      data-product-imagen={imagen || ""}
      data-product-descripcion={descripcion || ""}
      style="background: #D97706; color: #0A0A0A; width: 52px; height: 52px; font-family: 'Anton', sans-serif; font-size: 0.75rem; letter-spacing: 0.08em; text-transform: uppercase; border: none; flex-shrink: 0;"
      aria-label={`Agregar ${nombre} al carrito`}
    >
      <svg
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="3.5"
        stroke-linecap="round"
        stroke-linejoin="round"
        style="margin-bottom: 2px;"
      >
        <line x1="12" y1="5" x2="12" y2="19"></line><line
          x1="5"
          y1="12"
          x2="19"
          y2="12"></line>
      </svg>
      <span style="font-size: 0.6rem;">AGREGAR</span>
    </button>
  </div>

  <!-- Added feedback flash -->
  <div
    class="added-feedback absolute inset-0 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"
    style="background: rgba(255,184,0,0.12); border: 2px solid #D97706;"
  >
    <div
      class="flex items-center gap-2 px-4 py-2"
      style="background: #D97706; color: #0A0A0A;"
    >
      <svg
        width="14"
        height="14"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="3.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
      <span
        style="font-family: 'Anton', sans-serif; font-size: 0.95rem; letter-spacing: 0.08em;"
        >¡LISTO!</span
      >
    </div>
  </div>
</article>

<script>
  import { prefetchDriveImage } from "../lib/imageUtils.js";

  document
    .querySelectorAll<HTMLButtonElement>(".add-to-cart-btn")
    .forEach((btn) => {
      const imagen = btn.dataset.productImagen || "";

      let prefetched = false;
      const maybePrefetch = () => {
        if (prefetched || !imagen) return;
        prefetched = true;
        prefetchDriveImage(imagen);
      };
      btn.addEventListener("mouseenter", maybePrefetch, { passive: true });
      btn.addEventListener("touchstart", maybePrefetch, { passive: true });

      btn.addEventListener("click", () => {
        const id = btn.dataset.productId!;
        const nombre = btn.dataset.productNombre!;
        const precio = Number(btn.dataset.productPrecio!);
        const categoria = btn.dataset.productCategoria || "";
        const descripcion = btn.dataset.productDescripcion || "";

        document.dispatchEvent(
          new CustomEvent("open-extras-modal", {
            detail: { id, nombre, precio, categoria, imagen, descripcion },
            bubbles: true,
          })
        );
      });
    });
</script>
