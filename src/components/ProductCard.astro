---
export interface Props {
  id: string;
  nombre: string;
  descripcion: string;
  precio: number;
  imagen: string | null;
  badge?: string | null;
  categoria?: string;
}

const { id, nombre, descripcion, precio, imagen, badge, categoria } = Astro.props;

// La imagen se muestra SOLO en el modal de extras, no en la tarjeta del menú
const hasImage = false;

const precioFormateado = new Intl.NumberFormat('es-AR', {
  style: 'currency',
  currency: 'ARS',
  minimumFractionDigits: 0,
  maximumFractionDigits: 0,
}).format(precio);

// Badge colors — estilo sticker retro
// Se comparan automáticamente en MAYÚSCULAS
const badgeColors: Record<string, { bg: string; text: string }> = {
  'NUEVO':     { bg: '#E8681A', text: '#0D0D0D' },
  'OFERTA':    { bg: '#0D0D0D', text: '#E8681A' },
  'ESPECIAL':  { bg: '#E8681A', text: '#0D0D0D' },
  'DOBLE':     { bg: '#0D0D0D', text: '#F5F0E8' },
  'TRIPLE':    { bg: '#0D0D0D', text: '#E8681A' },
  'XXL':       { bg: '#0D0D0D', text: '#E8681A' },
  'PROMO':     { bg: '#E8681A', text: '#0D0D0D' },
  'VEGGIE':    { bg: '#4A5D23', text: '#F5F0E8' }, // Verde musgo con texto crema
};

const badgeUpper = badge?.toUpperCase() || '';
const badgeStyle = badgeUpper && badgeColors[badgeUpper] ? badgeColors[badgeUpper] : { bg: '#E8681A', text: '#0D0D0D' };
---

<!-- Sticker-style card: white bg, black border, orange shadow offset -->
<article
  class="product-card group relative flex flex-row items-start gap-3 overflow-hidden transition-all duration-200"
  data-product-id={id}
  data-product-nombre={nombre}
  data-product-precio={precio}
  data-product-categoria={categoria || ''}
  style="background: #FFFFFF; border: 2px solid #0D0D0D; box-shadow: 4px 4px 0px #E8681A; padding: 10px;"
>
  {hasImage && (
    <!-- LEFT: Square image with hard border -->
    <div class="relative flex-shrink-0 w-24 h-24 overflow-hidden" style="border: 2px solid #0D0D0D;">
      <img
        src={imagen}
        alt={nombre}
        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
        loading="lazy"
        decoding="async"
        onerror="this.src='https://placehold.co/200x200/0D0D0D/E8681A?text=MENU'"
      />
      {badge && (
        <div
          class="absolute top-0 left-0 px-1.5 py-0.5 font-black uppercase"
          style={`background: ${badgeStyle.bg}; color: ${badgeStyle.text}; font-family: 'Bebas Neue', sans-serif; font-size: 0.7rem; letter-spacing: 0.05em; border-bottom: 1.5px solid #0D0D0D; border-right: 1.5px solid #0D0D0D;`}
        >
          {badge}
        </div>
      )}
    </div>
  )}

  <!-- RIGHT: Info -->
  <div class="flex-1 min-w-0 flex flex-col justify-between" style="min-height: 72px;">
    <div>
      <div class="flex items-center gap-2 flex-wrap">
        <!-- Product name in Bebas Neue -->
        <h3
          style="font-family: 'Bebas Neue', sans-serif; color: #0D0D0D; font-size: 1.1rem; line-height: 1.1; letter-spacing: 0.02em;"
        >
          {nombre}
        </h3>
        {!hasImage && badge && (
          <span
            style={`background: ${badgeStyle.bg}; color: ${badgeStyle.text}; font-family: 'Bebas Neue', sans-serif; font-size: 0.7rem; padding: 0 5px; letter-spacing: 0.05em; border: 1.5px solid #0D0D0D;`}
          >
            {badge}
          </span>
        )}
      </div>
      <p
        class="text-xs leading-snug mt-0.5"
        style="color: #6B6660; display: -webkit-box; -webkit-line-clamp: 4; line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;"
      >
        {descripcion}
      </p>
    </div>

    <!-- Bottom: price + add button -->
    <div class="flex items-center justify-between mt-2">
      <!-- Price in Bebas Neue, orange -->
      <span style="font-family: 'Bebas Neue', sans-serif; color: #E8681A; font-size: 1.4rem; line-height: 1;">
        {precioFormateado}
      </span>
      <!-- ADD TO CART button — sticker brutalista -->
      <button
        class="add-to-cart-btn flex items-center gap-1.5 px-3 py-1.5 font-bold text-xs transition-all duration-150 active:translate-x-[2px] active:translate-y-[2px] select-none"
        data-product-id={id}
        data-product-nombre={nombre}
        data-product-precio={precio}
        data-product-categoria={categoria || ''}
        data-product-imagen={imagen || ''}
        data-product-descripcion={descripcion || ''}
        style="background: #E8681A; color: #0D0D0D; border: 2px solid #0D0D0D; box-shadow: 3px 3px 0px #0D0D0D; font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem; letter-spacing: 0.05em;"
        aria-label={`Agregar ${nombre} al carrito`}
      >
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        AGREGAR
      </button>
    </div>
  </div>

  <!-- Added feedback flash — orange overlay -->
  <div
    class="added-feedback absolute inset-0 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"
    style="background: rgba(232,104,26,0.12); border: 2.5px solid #E8681A;"
  >
    <div
      class="flex items-center gap-1.5 px-4 py-1.5"
      style="background: #E8681A; border: 2px solid #0D0D0D; box-shadow: 3px 3px 0px #0D0D0D;"
    >
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#0D0D0D" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      <span style="font-family: 'Bebas Neue', sans-serif; color: #0D0D0D; font-size: 1rem; letter-spacing: 0.05em;">¡LISTO!</span>
    </div>
  </div>
</article>

<script>
  import { prefetchDriveImage } from '../lib/imageUtils.js';

  document.querySelectorAll<HTMLButtonElement>('.add-to-cart-btn').forEach((btn) => {
    const imagen = btn.dataset.productImagen || '';

    // ── Prefetch image on first interaction (hover / touch) ──────────
    // This starts downloading the Drive thumbnail BEFORE the modal opens,
    // hiding most of the network latency. Browser cache ensures the image
    // is instant on subsequent opens of the same product.
    let prefetched = false;
    const maybePrefetch = () => {
      if (prefetched || !imagen) return;
      prefetched = true;
      prefetchDriveImage(imagen);
    };
    btn.addEventListener('mouseenter', maybePrefetch, { passive: true });
    btn.addEventListener('touchstart', maybePrefetch, { passive: true });

    // ── Open modal on click ────────────────────────────────────────
    btn.addEventListener('click', () => {
      const id       = btn.dataset.productId!;
      const nombre   = btn.dataset.productNombre!;
      const precio   = Number(btn.dataset.productPrecio!);
      const categoria = btn.dataset.productCategoria || '';
      const descripcion = btn.dataset.productDescripcion || '';

      document.dispatchEvent(new CustomEvent('open-extras-modal', {
        detail: { id, nombre, precio, categoria, imagen, descripcion },
        bubbles: true
      }));
    });
  });
</script>
