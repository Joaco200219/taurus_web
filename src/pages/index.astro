---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import CategorySection from "../components/CategorySection.astro";
import CartFloatingButton from "../components/CartFloatingButton.astro";
import ModalExtras from "../components/ModalExtras.astro";
import { getMenuData, getExtras } from "../lib/googleSheets";

const menuData = await getMenuData();
const extrasData = await getExtras();
---

<Layout>
  <Header />

  <!-- ===== HERO — STADIUM ENTRANCE BANNER ===== -->
  <div
    class="hero-banner relative overflow-hidden"
    style="background: #0A0A0A;"
  >
    <!-- Hero image: cabecera.png como banner full-width -->
    <img src="/cabecera.png" alt="Taurus Burgers — Menú" class="hero-img" />

    <!-- Dark overlay -->
    <div class="hero-overlay"></div>

    <!-- Grain texture -->
    <div
      class="absolute inset-0 pointer-events-none"
      style={`background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.15'/%3E%3C/svg%3E"); background-size:300px 300px; mix-blend-mode: overlay;`}
    >
    </div>

    <!-- Tagline: Scoreboard style -->
    <div class="hero-tagline">
      <div class="hero-tagline-inner">
        <div class="hero-line"></div>
        <p class="hero-text">AUTÉNTICO &bull; CALLEJERO &bull; BRUTAL</p>
        <div class="hero-line"></div>
      </div>
    </div>

    <!-- Red bottom stripe (field line) -->
    <div
      class="w-full"
      style="height: 4px; background: linear-gradient(90deg, #D81120, #FF2233, #D81120); position: relative; z-index: 3;"
    >
    </div>
  </div>

  <!-- ===== CATEGORY NAVIGATION — STADIUM TABS ===== -->
  <nav
    class="sticky z-40 overflow-x-auto no-scrollbar"
    style="top: 75px; background: #0A0A0A; border-bottom: 2px solid #D81120; backdrop-filter: blur(12px);"
  >
    <div class="flex min-w-full px-2">
      {
        menuData.map((cat) => (
          <a
            href={`#${cat.id}`}
            class="nav-tab flex-shrink-0 px-4 py-2.5 text-center whitespace-nowrap transition-all duration-200 relative"
            style="font-family: 'Anton', sans-serif; font-size: 0.85rem; letter-spacing: 0.08em; color: #A3A3A3; border-bottom: 3px solid transparent; margin-bottom: -2px;"
            data-nav-pill={cat.id}
          >
            {cat.category}
          </a>
        ))
      }
    </div>
  </nav>

  <!-- ===== MENU ===== -->
  <main class="pb-32 max-w-4xl mx-auto pt-4">
    {
      menuData.map((category) => (
        <CategorySection
          id={category.id}
          category={category.category}
          emoji={category.emoji}
          categoryKey={category.category}
          products={category.products}
        />
      ))
    }
  </main>

  <ModalExtras />
  <CartFloatingButton />
</Layout>

<style is:global>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* ===== HERO BANNER ===== */
  .hero-banner {
    position: relative;
    width: 100%;
    height: 220px;
  }

  .hero-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center 35%;
    display: block;
  }

  .hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      rgba(10, 10, 10, 0.1) 0%,
      rgba(10, 10, 10, 0.3) 40%,
      rgba(10, 10, 10, 0.85) 80%,
      rgba(10, 10, 10, 0.97) 100%
    );
    z-index: 1;
  }

  .hero-tagline {
    position: absolute;
    bottom: 16px;
    left: 0;
    right: 0;
    z-index: 2;
    padding: 0 20px;
  }

  .hero-tagline-inner {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .hero-line {
    flex: 1;
    height: 2px;
    background: rgba(255, 255, 255, 0.3);
  }

  .hero-text {
    font-family: "Anton", sans-serif;
    color: #ffffff;
    font-size: 0.85rem;
    letter-spacing: 0.25em;
    white-space: nowrap;
    margin: 0;
  }

  @media (min-width: 640px) {
    .hero-banner {
      height: 300px;
    }
    .hero-text {
      font-size: 1rem;
      letter-spacing: 0.3em;
    }
  }

  @media (min-width: 1024px) {
    .hero-banner {
      height: 360px;
    }
  }

  /* ===== NAV TABS ===== */
  .nav-tab {
    color: #a3a3a3;
    border-bottom: 3px solid transparent;
  }
  .nav-tab.is-active {
    color: #ffffff !important;
    border-bottom-color: #d81120 !important;
  }
</style>

<!-- Inject extras data -->
<script define:vars={{ extrasData }}>
  window.__MENU_EXTRAS__ = extrasData;
</script>

<script>
  const sections = document.querySelectorAll("section[id]");
  const tabs = document.querySelectorAll("[data-nav-pill]");

  // Active tab style — red underline, white text
  const activeStyle = {
    color: "#FFFFFF",
    borderBottomColor: "#D81120",
    background: "transparent",
  };
  const inactiveStyle = {
    color: "#A3A3A3",
    borderBottomColor: "transparent",
    background: "transparent",
  };

  function setActiveTab(id: string) {
    tabs.forEach((tab) => {
      const el = tab as HTMLElement;
      const isActive = el.dataset.navPill === id;
      const s = isActive ? activeStyle : inactiveStyle;
      el.style.color = s.color;
      el.style.borderBottomColor = s.borderBottomColor;
      el.style.background = s.background;

      if (isActive) {
        el.scrollIntoView({
          behavior: "smooth",
          block: "nearest",
          inline: "center",
        });
      }
    });
  }

  // Set first tab active by default
  if (tabs.length > 0) {
    const first = tabs[0] as HTMLElement;
    first.style.color = "#FFFFFF";
    first.style.borderBottomColor = "#D81120";
  }

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) setActiveTab(entry.target.id);
      });
    },
    { rootMargin: "-20% 0px -60% 0px" }
  );

  sections.forEach((section) => observer.observe(section));
</script>
